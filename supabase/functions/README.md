# Supabase Edge Functions

This directory contains the Supabase Edge Functions for the 10xGains application. These functions are deployed to the Supabase platform and serve as the API backend for the application.

## Architecture

The Edge Functions are organized into the following structure:

- `supabase/functions/[function-name]/` - Directory for a single deployable Supabase Edge Function.
  - `index.ts` - Main entry point for the function, typically setting up the primary router.
  - `deno.json` - Function-specific Deno configuration and dependencies.
  - `handlers/` - Subdirectory for complex functions that handle multiple path patterns.
    - `[path-pattern-name]/handler.ts` - Handles a specific path pattern (e.g., `/resource`, `/resource/:id`).
    - `[path-pattern-name]/methods/` - Contains the actual logic for each HTTP method (`get.ts`, `post.ts`, etc.).
- `supabase/functions/shared/` - Contains shared utilities and types used across multiple functions.
  - `database-types.ts` - Database type definitions (auto-generated by Supabase).
  - `api-types.ts` - Shared API DTOs and Command model type definitions.
  - `api-helpers.ts` - Helper functions for creating consistent API responses (e.g., `createSuccessResponse`, `createErrorResponse`), CORS headers, and other common utilities.
  - `api-handler.ts` - Core utilities for the advanced routing mechanism (e.g., `createMainRouterHandler`, `routeRequestToMethods`, `ApiHandlerContext`).

For simpler functions handling a single resource or a few methods without complex path variations, the structure might be simpler, potentially with method logic directly in or called from the main `index.ts`. However, for resources like `training-plans` that cover multiple paths (e.g., `/training-plans` and `/training-plans/:id`), the more advanced `handlers/` and `methods/` structure is preferred for better organization and scalability.

## API Handler Framework

The Edge Functions utilize an advanced, layered API routing and handling framework, particularly for functions managing multiple related path patterns under a single deployed Supabase Function (e.g., `training-plans` function handling `/training-plans` and `/training-plans/:planId`). This framework is primarily built from utilities in `shared/api-handler.ts` and `shared/api-helpers.ts`.

**Key Components:**

1.  **Main Router (`createMainRouterHandler`):**
    *   Located in the root `index.ts` of a function's directory (e.g., `supabase/functions/training-plans/index.ts`).
    *   **Responsibilities:**
        *   Handles initial CORS preflight (`OPTIONS`) requests.
        *   Performs JWT-based user authentication. If authentication fails, it returns a `401 Unauthorized` response.
        *   Creates a Supabase client instance authenticated with the user's context.
        *   Prepares an `ApiHandlerContext` object containing the authenticated `user`, `supabaseClient`, the original `Request` object, parsed `URL`, and `requestInfo` for logging.
        *   Iterates through an array of registered "Path Handler" functions, passing the `Request` and `ApiHandlerContext` to each, until one successfully handles the request (i.e., does not return a special `PASS_ROUTE_INDICATOR`).
        *   Returns a `404 Not Found` if no Path Handler matches the incoming request.

2.  **Path Handlers (e.g., `supabase/functions/training-plans/handlers/training-plans-id/handler.ts`):**
    *   Each Path Handler is responsible for a specific path pattern within the main function's scope (e.g., `/training-plans`, `/training-plans/:planId`).
    *   **Structure & Responsibilities:**
        *   Exports an async function (e.g., `handleTrainingPlanByIdRoute`) that accepts `(req: Request, context: ApiHandlerContext)`.
        *   Defines an `ABSOLUTE_PATH_PATTERN` string (e.g., `'/training-plans/:planId'`) used for matching and extracting path parameters.
        *   Imports "Method Handler" functions from a nested `methods/` subdirectory.
        *   Utilizes `routeRequestToMethods` (from `shared/api-handler.ts`) to:
            *   Match the `req.url.pathname` against its `ABSOLUTE_PATH_PATTERN`.
            *   If matched, extract `rawPathParams` from the URL and add them to the `ApiHandlerContext`.
            *   Dispatch the request to the correct Method Handler based on `req.method` (e.g., `GET`, `POST`).
            *   If the path doesn't match, it returns `PASS_ROUTE_INDICATOR`, signaling the Main Router to try the next Path Handler.

3.  **Method Handlers (e.g., `supabase/functions/training-plans/handlers/training-plans-id/methods/get.ts`):**
    *   These files contain the core business logic for each specific endpoint (HTTP method + path pattern combination).
    *   **Structure & Responsibilities:**
        *   Exports an async function (e.g., `handleGetTrainingPlanById`) that accepts the `ApiHandlerContext` (now including `rawPathParams` if applicable).
        *   Performs validation of `rawPathParams` and the request body (if any) using Zod schemas.
        *   Interacts with the database using the `supabaseClient` and `user` from the context.
        *   **Crucially, for operations on specific resources (e.g., those identified by an ID), these handlers must explicitly include `user.id` in database queries (e.g., `.eq('user_id', user.id)`) to enforce ownership, in addition to relying on RLS.** This ensures consistent `404 Not Found` responses for non-existent or unauthorized resources directly from the application logic.
        *   Constructs and returns success or error responses using helper functions like `createSuccessResponse(statusCode, data, message)` and `createErrorResponse` from `shared/api-helpers.ts`.

**Benefits:**
-   Clear separation of concerns: routing, path matching, authentication, and business logic.
-   Modular and scalable structure for complex API resources within a single deployed function.
-   Consistent handling of requests, authentication, and responses.

## Type Synchronization

To maintain a single source of truth for types, we automatically copy types from the Angular frontend to the Supabase Edge Functions before deployment:

1.  The sources of truth are:
    *   `src/app/shared/api/api.types.ts` - API DTOs and command models
    *   `src/app/shared/db/database.types.ts` - Database schema definitions
2.  The `copy-api-types.js` script copies these to:
    *   `supabase/functions/shared/api-types.ts`
    *   `supabase/functions/shared/database-types.ts`

Never edit the Edge Function types directly. Always modify the source files in the Angular project.

## Development Notes

### Dependency Management

Each function has its own `deno.json` file that manages dependencies and Deno-specific configurations. This follows the recommended Supabase practice to isolate dependencies per function:

```json
{
  "imports": {
    "std/": "https://deno.land/std@0.168.0/",
    "shared/": "../shared/",
    "supabase": "https://esm.sh/@supabase/supabase-js@2",
    "zod": "https://deno.land/x/zod@v3.22.4/mod.ts"
  }
}
```

### TypeScript Support

These functions use Deno as the runtime environment, which is different from Node.js. This means that:

1.  Import paths are managed through the `imports` section in `deno.json`
2.  Dependencies are imported via URLs (e.g., `https://deno.land/...`) or npm packages with the new `npm:` prefix
3.  The Deno global is available for environment variables and other runtime features

The IDE may show TypeScript errors for Deno-specific features because the regular TypeScript compiler doesn't recognize them. These errors can be ignored as they don't affect the function's execution in the Supabase environment.

### Handling Linting Errors in VS Code

If you're seeing linting errors in VS Code for Deno imports or types, you can:

1.  **Use Deno for VS Code Extension**: Install the official Deno extension and enable it for this workspace
2.  **Configure TypeScript Plugin**: Add a `.vscode/settings.json` file with:
    ```json
    {
      "deno.enable": true,
      "deno.lint": true,
      "deno.unstable": false
    }
    ```
3.  **Disable TypeScript Validation**: If you prefer to disable TypeScript validation for these files:
    ```json
    {
      "typescript.validate.enable": false
    }
    ```

### Local Development

To develop and test Edge Functions locally:

1.  Install the Supabase CLI
2.  Copy the latest API types with `yarn copy-api-types`
3.  Run `supabase functions serve [function-name]` (e.g., `supabase functions serve training-plans`) to start the local development server for a specific function.
4.  Use tools like Postman or curl to test the API endpoints.

### Deployment

To deploy Edge Functions:

```bash
# Deploy all functions
supabase functions deploy

# Deploy a specific function
supabase functions deploy [function-name] 
# Example: supabase functions deploy training-plans
```

## API Documentation

### Training Plans API

The Training Plans API is served by the `supabase/functions/training-plans` Edge Function.

#### GET /training-plans

Lists all training plans for the authenticated user. Supports pagination and sorting.

-   **Authorization**: Bearer token required.
-   **URL Query Parameters**:
    -   `limit` (optional, integer): Number of plans to return.
    -   `offset` (optional, integer): Offset for pagination.
    -   `sort` (optional, string): Sort criteria (e.g., `name:asc`, `created_at:desc`).
-   **Response (200 OK)**: An array of `TrainingPlanDto` objects.
    ```json
    [
      {
        "id": "uuid",
        "name": "My Awesome Plan",
        "description": "A great plan for gains.",
        "user_id": "uuid",
        "created_at": "timestamp"
      }
    ]
    ```

#### POST /training-plans

Creates a new training plan for the authenticated user.

-   **Authorization**: Bearer token required.
-   **Request Body**: `CreateTrainingPlanCommand`
    ```json
    {
      "name": "string (required, max 255)",
      "description": "string (optional)"
    }
    ```
-   **Response (201 Created)**: The newly created `TrainingPlanDto` object.
    ```json
    {
      "id": "uuid",
      "name": "New Plan",
      "description": "Details about the new plan.",
      "user_id": "uuid",
      "created_at": "timestamp"
    }
    ```

#### GET /training-plans/{planId}

Retrieves a specific training plan by its ID, if it belongs to the authenticated user. Includes associated training days and exercises.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**: `planId` (UUID) - The ID of the training plan to retrieve.
-   **Response (200 OK)**: The `TrainingPlanDto` object, including `days` and their `exercises`.
    ```json
    {
      "id": "uuid",
      "name": "Specific Plan",
      "description": "Description of this plan.",
      "user_id": "uuid",
      "created_at": "timestamp",
      "days": [
        {
          "id": "uuid",
          "name": "Day 1: Push",
          /* ... other day fields ... */
          "exercises": [
            {
              "id": "uuid",
              /* ... other exercise fields ... */
            }
          ]
        }
      ]
    }
    ```
-   **Response (404 Not Found)**: If the plan is not found or not accessible to the user.

#### PUT /training-plans/{planId}

Updates an existing training plan by its ID, if it belongs to the authenticated user.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**: `planId` (UUID) - The ID of the training plan to update.
-   **Request Body**: `UpdateTrainingPlanCommand` (at least one field must be present)
    ```json
    {
      "name": "string (optional, max 255)",
      "description": "string (optional)"
    }
    ```
-   **Response (200 OK)**: The updated `TrainingPlanDto` object.
    ```json
    {
      "id": "uuid",
      "name": "Updated Plan Name",
      "description": "Updated description.",
      "user_id": "uuid",
      "updated_at": "timestamp" 
    }
    ```
-   **Response (404 Not Found)**: If the plan is not found or not accessible to the user for an update.

#### DELETE /training-plans/{planId}

Deletes a specific training plan by its ID, if it belongs to the authenticated user.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**: `planId` (UUID) - The ID of the training plan to delete.
-   **Response (204 No Content)**: Indicates successful deletion with no response body.
-   **Response (404 Not Found)**: If the plan is not found or not accessible to the user for deletion.

### Training Plan Days API

Manages days within a specific training plan. All endpoints require Bearer token authorization.

#### GET /training-plans/{planId}/days

Retrieves a list of all training days for a specified training plan. Includes nested exercise and set data.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**:
    -   `planId` (UUID, required): The ID of the training plan.
-   **URL Query Parameters**:
    -   `limit` (optional, integer, default: 20, max: 100): Number of days to return.
    -   `offset` (optional, integer, default: 0): Offset for pagination.
-   **Response (200 OK)**: An array of `TrainingPlanDayDto` objects.
    ```json
    [
      {
        "id": "uuid",
        "name": "Day 1: Push",
        "description": "Chest, Shoulders, Triceps",
        "order_index": 1,
        "training_plan_id": "uuid",
        "exercises": [
          {
            "id": "uuid",
            "exercise_id": "uuid",
            "training_plan_day_id": "uuid",
            "order_index": 1,
            "sets": [
              {
                "id": "uuid",
                "training_plan_exercise_id": "uuid",
                "set_index": 1,
                "expected_reps": 10,
                "expected_weight": 52.5
              }
            ]
          }
        ]
      }
    ]
    ```
-   **Response (400 Bad Request)**: If `planId` format is invalid or pagination parameters are incorrect.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan with `planId` is not found or not accessible to the user.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### POST /training-plans/{planId}/days

Creates a new training day within a specified training plan. `order_index` is managed by the backend.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**:
    -   `planId` (UUID, required): The ID of the training plan.
-   **Request Body**: `CreateTrainingPlanDayCommand`
    ```json
    {
      "name": "string (required)",
      "description": "string | null (optional)",
      "order_index": "integer (optional, positive)"
    }
    ```
-   **Response (201 Created)**: The newly created `TrainingPlanDayDto` object (without nested exercises).
    ```json
    {
      "id": "uuid",
      "name": "Day 2: Pull",
      "description": "Back, Biceps",
      "order_index": 2,
      "training_plan_id": "uuid",
      "created_at": "timestamp",
      "updated_at": "timestamp"
    }
    ```
-   **Response (400 Bad Request)**: If `planId` format is invalid or the request body is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan with `planId` is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### GET /training-plans/{planId}/days/{dayId}

Retrieves details for a specific training day, including nested exercise and set data.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
-   **Response (200 OK)**: The `TrainingPlanDayDto` object, including `exercises` and their `sets`.
    ```json
    {
      "id": "uuid",
      "name": "Day 1: Push",
      "description": "Chest, Shoulders, Triceps",
      "order_index": 1,
      "training_plan_id": "uuid",
      "created_at": "timestamp",
      "updated_at": "timestamp",
      "exercises": [ /* ... as in GET /training-plans/{planId}/days ... */ ]
    }
    ```
-   **Response (400 Bad Request)**: If `planId` or `dayId` format is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan or day is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### PUT /training-plans/{planId}/days/{dayId}

Updates an existing training day. If `order_index` is changed, reordering of other days occurs.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day to update.
-   **Request Body**: `UpdateTrainingPlanDayCommand` (at least one field must be present)
    ```json
    {
      "name": "string (optional)",
      "description": "string | null (optional)",
      "order_index": "integer (optional, positive)"
    }
    ```
-   **Response (200 OK)**: The updated `TrainingPlanDayDto` object (without nested exercises).
    ```json
    {
      "id": "uuid",
      "name": "Day 1: Upper Body Push",
      "description": "Focus on compound movements",
      "order_index": 1,
      "training_plan_id": "uuid",
      "created_at": "timestamp", 
      "updated_at": "timestamp"
    }
    ```
-   **Response (400 Bad Request)**: If `planId` or `dayId` format is invalid, or the request body is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan or day is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### DELETE /training-plans/{planId}/days/{dayId}

Deletes a specific training day. Reordering of subsequent days occurs automatically.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day to delete.
-   **Response (204 No Content)**: Indicates successful deletion with no response body.
-   **Response (400 Bad Request)**: If `planId` or `dayId` format is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan or day is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

### Training Plan Exercises API

Manages exercises within a specific training plan day. All endpoints require Bearer token authorization. These endpoints typically interact with RPC functions like `create_training_plan_exercise`, `update_training_plan_exercise_order`, and `delete_training_plan_exercise`.

#### GET /training-plans/{planId}/days/{dayId}/exercises

Retrieves a list of all exercises for a specified training day.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
-   **URL Query Parameters**:
    -   `limit` (optional, integer, default: 20, max: 100): Number of exercises to return.
    -   `offset` (optional, integer, default: 0): Offset for pagination.
-   **Response (200 OK)**: An array of `TrainingPlanExerciseDto` objects.
    ```json
    [
      {
        "id": "uuid",
        "exercise_id": "uuid", // References the global exercises table
        "training_plan_day_id": "uuid",
        "order_index": 1,
        "sets": [ /* Array of TrainingPlanExerciseSetDto */ ]
      }
    ]
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid or pagination parameters are incorrect.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan or day is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### POST /training-plans/{planId}/days/{dayId}/exercises

Adds a new exercise to a specified training day. `order_index` is managed by the backend.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
-   **Request Body**: `CreateTrainingPlanExerciseCommand`
    ```json
    {
      "exercise_id": "uuid (required)", // ID of the exercise from the global exercises table
      "order_index": "integer (optional, positive)" // If omitted, appends to the end
    }
    ```
-   **Response (201 Created)**: The newly created `TrainingPlanExerciseDto` object (without nested sets usually, unless explicitly designed to return them).
    ```json
    {
      "id": "uuid",
      "exercise_id": "uuid",
      "training_plan_day_id": "uuid",
      "order_index": 1
    }
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid or the request body is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, or the referenced global exercise is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### PUT /training-plans/{planId}/days/{dayId}/exercises/{planExerciseId}

Updates an existing exercise within a training day, primarily for reordering.
This endpoint corresponds to the `update_training_plan_exercise_order` RPC.
If other fields of `training_plan_exercises` need to be updated, a separate endpoint or an extension to this one might be required.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
    -   `planExerciseId` (UUID, required): The ID of the training plan exercise entry to update.
-   **Request Body**: `UpdateTrainingPlanExerciseOrderCommand`
    ```json
    {
      "order_index": "integer (required, positive)"
    }
    ```
-   **Response (200 OK)**: The updated `TrainingPlanExerciseDto` object.
    ```json
    {
      "id": "uuid",
      "exercise_id": "uuid",
      "training_plan_day_id": "uuid",
      "order_index": 2 // Updated order_index
    }
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid or the request body is invalid (e.g., missing `order_index`).
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, or specific plan exercise is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs during the update or reordering.

#### DELETE /training-plans/{planId}/days/{dayId}/exercises/{planExerciseId}

Deletes a specific exercise from a training day. Reordering of subsequent exercises occurs automatically.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
    -   `planExerciseId` (UUID, required): The ID of the training plan exercise entry to delete.
-   **Response (204 No Content)**: Indicates successful deletion with no response body.
-   **Response (400 Bad Request)**: If path parameter formats are invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, or specific plan exercise is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

### Training Plan Exercise Sets API

Manages sets for a specific exercise within a training plan day. All endpoints require Bearer token authorization.

#### GET /training-plans/{planId}/days/{dayId}/exercises/{planExerciseId}/sets

Retrieves a list of all sets for a specified exercise within a training day.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
    -   `planExerciseId` (UUID, required): The ID of the training plan exercise.
-   **URL Query Parameters**:
    -   `limit` (optional, integer, default: 20, max: 100): Number of sets to return.
    -   `offset` (optional, integer, default: 0): Offset for pagination.
-   **Response (200 OK)**: An array of `TrainingPlanExerciseSetDto` objects.
    ```json
    [
      {
        "id": "uuid",
        "training_plan_exercise_id": "uuid",
        "set_index": 1,
        "expected_reps": 5,
        "expected_weight": 52.5
      }
    ]
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid or pagination parameters are incorrect.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, or exercise is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### POST /training-plans/{planId}/days/{dayId}/exercises/{planExerciseId}/sets

Creates a new set for a specified exercise within a training day. `set_index` is typically managed by the backend or can be optionally provided.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
    -   `planExerciseId` (UUID, required): The ID of the training plan exercise.
-   **Request Body**: `CreateTrainingPlanExerciseSetCommand`
    ```json
    {
      "set_index": "integer (optional, positive)",
      "expected_reps": "integer (required, positive)",
      "expected_weight": "number (required, positive)"
    }
    ```
-   **Response (201 Created)**: The newly created `TrainingPlanExerciseSetDto` object.
    ```json
    {
      "id": "uuid",
      "training_plan_exercise_id": "uuid",
      "set_index": 1,
      "expected_reps": 5,
      "expected_weight": 52.5
    }
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid or the request body is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, or exercise is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### GET /training-plans/{planId}/days/{dayId}/exercises/{planExerciseId}/sets/{setId}

Retrieves details for a specific set.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
    -   `planExerciseId` (UUID, required): The ID of the training plan exercise.
    -   `setId` (UUID, required): The ID of the training plan exercise set.
-   **Response (200 OK)**: The `TrainingPlanExerciseSetDto` object.
    ```json
    {
      "id": "uuid",
      "training_plan_exercise_id": "uuid",
      "set_index": 1,
      "expected_reps": 5,
      "expected_weight": 52.5
    }
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, exercise, or set is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### PUT /training-plans/{planId}/days/{dayId}/exercises/{planExerciseId}/sets/{setId}

Updates an existing set.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
    -   `planExerciseId` (UUID, required): The ID of the training plan exercise.
    -   `setId` (UUID, required): The ID of the training plan exercise set to update.
-   **Request Body**: `UpdateTrainingPlanExerciseSetCommand` (at least one field must be present)
    ```json
    {
      "set_index": "integer (optional, positive)",
      "expected_reps": "integer (optional, positive)",
      "expected_weight": "number (optional, positive)"
    }
    ```
-   **Response (200 OK)**: The updated `TrainingPlanExerciseSetDto` object.
    ```json
    {
      "id": "uuid",
      "training_plan_exercise_id": "uuid",
      "set_index": 1,
      "expected_reps": 5,
      "expected_weight": 55.0
    }
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid or the request body is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, exercise, or set is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### DELETE /training-plans/{planId}/days/{dayId}/exercises/{planExerciseId}/sets/{setId}

Deletes a specific set. Reordering of subsequent sets (if `set_index` is managed) occurs automatically.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `dayId` (UUID, required): The ID of the training plan day.
    -   `planExerciseId` (UUID, required): The ID of the training plan exercise.
    -   `setId` (UUID, required): The ID of the training plan exercise set to delete.
-   **Response (204 No Content)**: Indicates successful deletion with no response body.
-   **Response (400 Bad Request)**: If path parameter formats are invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, day, exercise, or set is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

### Training Plan Exercise Progression API

Manages progression rules for a specific exercise within a training plan. All endpoints require Bearer token authorization.

#### GET /training-plans/{planId}/exercises/{exerciseId}/progression

Retrieves the progression rule for a specific exercise within a training plan day.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `exerciseId` (UUID, required): The ID of the exercise (from the global `exercises` table) for which progression is being fetched. This corresponds to the `exercise_id` in the `training_plan_exercises` table when linking an exercise to a plan day, and subsequently to the `training_plan_exercise_progressions` table.
-   **Response (200 OK)**: The `TrainingPlanExerciseProgressionDto` object.
    ```json
    {
      "id": "uuid",
      "training_plan_id": "uuid",
      "exercise_id": "uuid",
      "weight_increment": 2.5,
      "failure_count_for_deload": 3,
      "deload_percentage": 10.0,
      "deload_strategy": "PROPORTIONAL",
      "current_weight": 50.0,
      "consecutive_failures": 0,
      "last_updated": "2023-01-01T00:00:00Z",
      "reference_set_index": null
    }
    ```
-   **Response (400 Bad Request)**: If path parameter formats are invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan, exercise, or the specific progression rule is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### PUT /training-plans/{planId}/exercises/{exerciseId}/progression

Creates or updates (upserts) the progression rule for a specific exercise within a training plan.

-   **Authorization**: Bearer token required.
-   **URL Path Parameters**:
    -   `planId` (UUID, required): The ID of the training plan.
    -   `exerciseId` (UUID, required): The ID of the exercise (from the global `exercises` table).
-   **Request Body**: `UpdateTrainingPlanExerciseProgressionCommand` (at least one field must be present for an update; `weight_increment`, `failure_count_for_deload`, `current_weight` are required if creating a new progression rule for an exercise that doesn't have one).
    ```json
    {
      "weight_increment": 2.5,                // Optional (Required for create), NUMERIC(7,3) > 0
      "failure_count_for_deload": 3,          // Optional (Required for create), SMALLINT > 0
      "current_weight": 50.0,                 // Optional (Required for create), NUMERIC(7,3) > 0
      "consecutive_failures": 0,              // Optional, SMALLINT >= 0
      "deload_percentage": 10.0,              // Optional, NUMERIC(4,2) > 0
      "deload_strategy": "PROPORTIONAL",      // Optional, ENUM('PROPORTIONAL', 'REFERENCE_SET', 'CUSTOM')
      "reference_set_index": null             // Optional, SMALLINT >= 0 or null
    }
    ```
-   **Response (201 Created)**: If a new progression rule was created. Returns the `TrainingPlanExerciseProgressionDto`.
-   **Response (200 OK)**: If an existing progression rule was updated. Returns the `TrainingPlanExerciseProgressionDto`.
-   **Response (400 Bad Request)**: If path parameter formats are invalid, the request body is invalid (e.g., missing required fields for creation, invalid values), or no fields provided for update.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (404 Not Found)**: If the training plan or exercise is not found or not accessible.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

### Exercises API

The Exercises API is served by the `supabase/functions/exercises` Edge Function. It allows management of the global list of available exercises in the system. Modification operations (POST, PUT, DELETE) require administrator privileges.

#### GET /exercises

Lists all available exercises. Supports pagination and sorting.

-   **Authorization**: Optional Bearer token. Publicly accessible.
-   **URL Query Parameters**:
    -   `limit` (optional, integer, default: 20, max: 100): Number of exercises to return.
    -   `offset` (optional, integer, default: 0): Offset for pagination.
    -   `sort` (optional, string, default: `id.desc`): Sort criteria (e.g., `name.asc`).
-   **Response (200 OK)**: An array of `ExerciseDto` objects.
    ```json
    [
      {
        "id": "uuid",
        "name": "Squat",
        "description": "A lower-body exercise."
      }
      // ... other exercises
    ]
    ```
-   **Response (400 Bad Request)**: If pagination or sort parameters are invalid.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### POST /exercises

Creates a new exercise. Requires administrator privileges.

-   **Authorization**: Bearer token required (user must be an admin).
-   **Request Body**: `CreateExerciseCommand`
    ```json
    {
      "name": "string (required, min 1 char)",
      "description": "string (nullable, optional)"
    }
    ```
-   **Response (201 Created)**: The newly created `ExerciseDto` object.
    ```json
    {
      "id": "uuid",
      "name": "New Exercise",
      "description": "Details about the new exercise."
    }
    ```
-   **Response (400 Bad Request)**: If the request body is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (403 Forbidden)**: If the authenticated user is not an administrator.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### GET /exercises/{id}

Retrieves a specific exercise by its ID.

-   **Authorization**: Optional Bearer token. Publicly accessible.
-   **URL Path Parameter**: `id` (UUID, required) - The ID of the exercise to retrieve.
-   **Response (200 OK)**: The `ExerciseDto` object.
    ```json
    {
      "id": "uuid",
      "name": "Squat",
      "description": "A lower-body exercise."
    }
    ```
-   **Response (400 Bad Request)**: If `id` format is invalid (not a UUID).
-   **Response (404 Not Found)**: If the exercise is not found.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### PUT /exercises/{id}

Updates an existing exercise by its ID. Requires administrator privileges.

-   **Authorization**: Bearer token required (user must be an admin).
-   **URL Path Parameter**: `id` (UUID, required) - The ID of the exercise to update.
-   **Request Body**: `UpdateExerciseCommand` (at least one field must be present)
    ```json
    {
      "name": "string (optional, min 1 char if provided)",
      "description": "string (nullable, optional)"
    }
    ```
-   **Response (200 OK)**: The updated `ExerciseDto` object.
    ```json
    {
      "id": "uuid",
      "name": "Updated Exercise Name",
      "description": "Updated details about the exercise."
    }
    ```
-   **Response (400 Bad Request)**: If `id` format is invalid or the request body is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (403 Forbidden)**: If the authenticated user is not an administrator.
-   **Response (404 Not Found)**: If the exercise is not found for an update.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs.

#### DELETE /exercises/{id}

Deletes a specific exercise by its ID. Requires administrator privileges.

-   **Authorization**: Bearer token required (user must be an admin).
-   **URL Path Parameter**: `id` (UUID, required) - The ID of the exercise to delete.
-   **Response (204 No Content)**: Indicates successful deletion with no response body.
-   **Response (400 Bad Request)**: If `id` format is invalid.
-   **Response (401 Unauthorized)**: If the authentication token is missing or invalid.
-   **Response (403 Forbidden)**: If the authenticated user is not an administrator.
-   **Response (500 Internal Server Error)**: If an unexpected server error occurs during the delete operation (e.g., database error, not for a non-existent record which still returns 204).
