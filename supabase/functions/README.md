# Supabase Edge Functions

This directory contains the Supabase Edge Functions for the 10xGains application. These functions are deployed to the Supabase platform and serve as the API backend for the application.

## Architecture

The Edge Functions are organized into the following structure:

- `supabase/functions/[function-name]/` - Directory for a single deployable Supabase Edge Function.
  - `index.ts` - Main entry point for the function, typically setting up the primary router.
  - `deno.json` - Function-specific Deno configuration and dependencies.
  - `handlers/` - Subdirectory for complex functions that handle multiple path patterns.
    - `[path-pattern-name]/handler.ts` - Handles a specific path pattern (e.g., `/resource`, `/resource/:id`).
    - `[path-pattern-name]/methods/` - Contains the actual logic for each HTTP method (`get.ts`, `post.ts`, etc.).
- `supabase/functions/shared/` - Contains shared utilities and types used across multiple functions.
  - `database-types.ts` - Database type definitions (auto-generated by Supabase).
  - `api-types.ts` - Shared API DTOs and Command model type definitions.
  - `api-helpers.ts` - Helper functions for creating consistent API responses (e.g., `createSuccessResponse`, `createErrorResponse`), CORS headers, and other common utilities.
  - `api-routing.ts` - Core utilities for the advanced routing mechanism (e.g., `createMainRouterHandler`, `routeRequestToMethods`, `ApiHandlerContext`).

For simpler functions handling a single resource or a few methods without complex path variations, the structure might be simpler, potentially with method logic directly in or called from the main `index.ts`. However, for resources like `training-plans` that cover multiple paths (e.g., `/training-plans` and `/training-plans/:id`), the more advanced `handlers/` and `methods/` structure is preferred for better organization and scalability.

## API Handler Framework

The Edge Functions utilize an advanced, layered API routing and handling framework, particularly for functions managing multiple related path patterns under a single deployed Supabase Function (e.g., `training-plans` function handling `/training-plans` and `/training-plans/:planId`). This framework is primarily built from utilities in `shared/api-routing.ts` and `shared/api-helpers.ts`.

**Key Components:**

1.  **Main Router (`createMainRouterHandler`):**
    *   Located in the root `index.ts` of a function's directory (e.g., `supabase/functions/training-plans/index.ts`).
    *   **Responsibilities:**
        *   Handles initial CORS preflight (`OPTIONS`) requests.
        *   Performs JWT-based user authentication. If authentication fails, it returns a `401 Unauthorized` response.
        *   Creates a Supabase client instance authenticated with the user's context.
        *   Prepares an `ApiHandlerContext` object containing the authenticated `user`, `supabaseClient`, the original `Request` object, parsed `URL`, and `requestInfo` for logging.
        *   Iterates through an array of registered "Path Handler" functions, passing the `Request` and `ApiHandlerContext` to each, until one successfully handles the request (i.e., does not return a special `PASS_ROUTE_INDICATOR`).
        *   Returns a `404 Not Found` if no Path Handler matches the incoming request.

2.  **Path Handlers (e.g., `supabase/functions/training-plans/handlers/training-plans-id/handler.ts`):**
    *   Each Path Handler is responsible for a specific path pattern within the main function's scope (e.g., `/training-plans`, `/training-plans/:planId`).
    *   **Structure & Responsibilities:**
        *   Exports an async function (e.g., `handleTrainingPlanByIdRoute`) that accepts `(req: Request, context: ApiHandlerContext)`.
        *   Defines an `ABSOLUTE_PATH_PATTERN` string (e.g., `'/training-plans/:planId'`) used for matching and extracting path parameters.
        *   Imports "Method Handler" functions from a nested `methods/` subdirectory.
        *   Utilizes `routeRequestToMethods` (from `shared/api-routing.ts`) to:
            *   Match the `req.url.pathname` against its `ABSOLUTE_PATH_PATTERN`.
            *   If matched, extract `rawPathParams` from the URL and add them to the `ApiHandlerContext`.
            *   Dispatch the request to the correct Method Handler based on `req.method` (e.g., `GET`, `POST`).
            *   If the path doesn't match, it returns `PASS_ROUTE_INDICATOR`, signaling the Main Router to try the next Path Handler.

3.  **Method Handlers (e.g., `supabase/functions/training-plans/handlers/training-plans-id/methods/get.ts`):**
    *   These files contain the core business logic for each specific endpoint (HTTP method + path pattern combination).
    *   **Structure & Responsibilities:**
        *   Exports an async function (e.g., `handleGetTrainingPlanById`) that accepts the `ApiHandlerContext` (now including `rawPathParams` if applicable).
        *   Performs validation of `rawPathParams` and the request body (if any) using Zod schemas.
        *   Interacts with the database using the `supabaseClient` and `user` from the context.
        *   **Crucially, for operations on specific resources (e.g., those identified by an ID), these handlers must explicitly include `user.id` in database queries (e.g., `.eq('user_id', user.id)`) to enforce ownership, in addition to relying on RLS.** This ensures consistent `404 Not Found` responses for non-existent or unauthorized resources directly from the application logic.
        *   Constructs and returns success or error responses using helper functions like `createSuccessResponse(statusCode, data, message)` and `createErrorResponse` from `shared/api-helpers.ts`.

**Benefits:**
-   Clear separation of concerns: routing, path matching, authentication, and business logic.
-   Modular and scalable structure for complex API resources within a single deployed function.
-   Consistent handling of requests, authentication, and responses.

## Type Synchronization

To maintain a single source of truth for types, we automatically copy types from the Angular frontend to the Supabase Edge Functions before deployment:

1.  The sources of truth are:
    *   `src/app/shared/api/api.types.ts` - API DTOs and command models
    *   `src/app/shared/db/database.types.ts` - Database schema definitions
2.  The `copy-api-types.js` script copies these to:
    *   `supabase/functions/shared/api-types.ts`
    *   `supabase/functions/shared/database-types.ts`

Never edit the Edge Function types directly. Always modify the source files in the Angular project.

## Development Notes

### Dependency Management

Each function has its own `deno.json` file that manages dependencies and Deno-specific configurations. This follows the recommended Supabase practice to isolate dependencies per function:

```json
{
  "imports": {
    "std/": "https://deno.land/std@0.168.0/",
    "shared/": "../shared/",
    "supabase": "https://esm.sh/@supabase/supabase-js@2",
    "zod": "https://deno.land/x/zod@v3.22.4/mod.ts"
  }
}
```

### TypeScript Support

These functions use Deno as the runtime environment, which is different from Node.js. This means that:

1.  Import paths are managed through the `imports` section in `deno.json`
2.  Dependencies are imported via URLs (e.g., `https://deno.land/...`) or npm packages with the new `npm:` prefix
3.  The Deno global is available for environment variables and other runtime features

The IDE may show TypeScript errors for Deno-specific features because the regular TypeScript compiler doesn't recognize them. These errors can be ignored as they don't affect the function's execution in the Supabase environment.

### Handling Linting Errors in VS Code

If you're seeing linting errors in VS Code for Deno imports or types, you can:

1.  **Use Deno for VS Code Extension**: Install the official Deno extension and enable it for this workspace
2.  **Configure TypeScript Plugin**: Add a `.vscode/settings.json` file with:
    ```json
    {
      "deno.enable": true,
      "deno.lint": true,
      "deno.unstable": false
    }
    ```
3.  **Disable TypeScript Validation**: If you prefer to disable TypeScript validation for these files:
    ```json
    {
      "typescript.validate.enable": false
    }
    ```

### Local Development

To develop and test Edge Functions locally:

1.  Install the Supabase CLI
2.  Copy the latest API types with `yarn copy-api-types`
3.  Run `supabase functions serve [function-name]` (e.g., `supabase functions serve training-plans`) to start the local development server for a specific function.
4.  Use tools like Postman or curl to test the API endpoints.

### Deployment

To deploy Edge Functions:

```bash
# Deploy all functions
supabase functions deploy

# Deploy a specific function
supabase functions deploy [function-name] 
# Example: supabase functions deploy training-plans
```

## API Documentation

### Training Plans API

The Training Plans API is served by the `supabase/functions/training-plans` Edge Function.

#### GET /training-plans

Lists all training plans for the authenticated user. Supports pagination and sorting.

-   **Authorization**: Bearer token required.
-   **URL Query Parameters**:
    -   `limit` (optional, integer): Number of plans to return.
    -   `offset` (optional, integer): Offset for pagination.
    -   `sort` (optional, string): Sort criteria (e.g., `name:asc`, `created_at:desc`).
-   **Response (200 OK)**: An array of `TrainingPlanDto` objects.
    ```json
    [
      {
        "id": "uuid",
        "name": "My Awesome Plan",
        "description": "A great plan for gains.",
        "user_id": "uuid",
        "created_at": "timestamp"
      }
    ]
    ```

#### POST /training-plans

Creates a new training plan for the authenticated user.

-   **Authorization**: Bearer token required.
-   **Request Body**: `CreateTrainingPlanCommand`
    ```json
    {
      "name": "string (required, max 255)",
      "description": "string (optional)"
    }
    ```
-   **Response (201 Created)**: The newly created `TrainingPlanDto` object.
    ```json
    {
      "id": "uuid",
      "name": "New Plan",
      "description": "Details about the new plan.",
      "user_id": "uuid",
      "created_at": "timestamp"
    }
    ```

#### GET /training-plans/{planId}

Retrieves a specific training plan by its ID, if it belongs to the authenticated user. Includes associated training days and exercises.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**: `planId` (UUID) - The ID of the training plan to retrieve.
-   **Response (200 OK)**: The `TrainingPlanDto` object, including `days` and their `exercises`.
    ```json
    {
      "id": "uuid",
      "name": "Specific Plan",
      "description": "Description of this plan.",
      "user_id": "uuid",
      "created_at": "timestamp",
      "days": [
        {
          "id": "uuid",
          "name": "Day 1: Push",
          /* ... other day fields ... */
          "exercises": [
            {
              "id": "uuid",
              /* ... other exercise fields ... */
            }
          ]
        }
      ]
    }
    ```
-   **Response (404 Not Found)**: If the plan is not found or not accessible to the user.

#### PUT /training-plans/{planId}

Updates an existing training plan by its ID, if it belongs to the authenticated user.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**: `planId` (UUID) - The ID of the training plan to update.
-   **Request Body**: `UpdateTrainingPlanCommand` (at least one field must be present)
    ```json
    {
      "name": "string (optional, max 255)",
      "description": "string (optional)"
    }
    ```
-   **Response (200 OK)**: The updated `TrainingPlanDto` object.
    ```json
    {
      "id": "uuid",
      "name": "Updated Plan Name",
      "description": "Updated description.",
      "user_id": "uuid",
      "updated_at": "timestamp" 
    }
    ```
-   **Response (404 Not Found)**: If the plan is not found or not accessible to the user for an update.

#### DELETE /training-plans/{planId}

Deletes a specific training plan by its ID, if it belongs to the authenticated user.

-   **Authorization**: Bearer token required.
-   **URL Path Parameter**: `planId` (UUID) - The ID of the training plan to delete.
-   **Response (204 No Content)**: Indicates successful deletion with no response body.
-   **Response (404 Not Found)**: If the plan is not found or not accessible to the user for deletion.
